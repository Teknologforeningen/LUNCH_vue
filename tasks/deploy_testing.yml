- name: Specify git dir
  set_fact:
    git_dir: /srv/lunch
    url: lunch.dvalin.tf.fi

- name: Chown dir
  file:
    path: "/srv"
    state: directory
    owner: nginx
    recurse: yes

- name: Install apt packages
  package:
    name:
      - nodejs
      - npm
      - nginx
      - mongodb
    state: present

- name: Create nginx user
  user:
    name: nginx
    shell: /bin/false

- name: Template nginx config
  template:
    src: lunch_nginx.conf.j2
    dest: /etc/nginx/sites-available/lunch
    mode: '0644'

- name: Link nginx config
  file:
    src: /etc/nginx/sites-available/lunch
    path: /etc/nginx/sites-enabled/lunch
    state: link

- name: Clone repo
  git:
    repo: https://github.com/Teknologforeningen/LUNCH.git
    dest: "{{ git_dir }}"
    version: HEAD

- name: Install npm packages
  become: yes
  npm:
    ci: yes
    production: yes
    path: "{{ git_dir }}/lunch"

- name: Restart nginx
  service:
    name: nginx
    state: restarted
